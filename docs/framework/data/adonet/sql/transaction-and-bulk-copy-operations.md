---
title: 事务和批量复制操作
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: f6f0cbc9-f7bf-4d6e-875f-ad1ba0b4aa62
ms.openlocfilehash: 27fafc0ef45b80eddd993229f52d119b40b4956f
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/24/2020
ms.locfileid: "91155427"
---
# <a name="transaction-and-bulk-copy-operations"></a><span data-ttu-id="14edb-102">事务和批量复制操作</span><span class="sxs-lookup"><span data-stu-id="14edb-102">Transaction and Bulk Copy Operations</span></span>

<span data-ttu-id="14edb-103">大容量复制操作可以作为独立操作或作为多步事务的一部分执行。</span><span class="sxs-lookup"><span data-stu-id="14edb-103">Bulk copy operations can be performed as isolated operations or as part of a multiple step transaction.</span></span> <span data-ttu-id="14edb-104">后面这个选项使你能够在同一事务中执行多个大容量复制操作，以及执行其他数据库操作（例如插入、更新和删除），同时仍能够提交或回滚整个事务。</span><span class="sxs-lookup"><span data-stu-id="14edb-104">This latter option enables you to perform more than one bulk copy operation within the same transaction, as well as perform other database operations (such as inserts, updates, and deletes) while still being able to commit or roll back the entire transaction.</span></span>  
  
 <span data-ttu-id="14edb-105">默认情况下，大容量复制操作作为独立的操作执行。</span><span class="sxs-lookup"><span data-stu-id="14edb-105">By default, a bulk copy operation is performed as an isolated operation.</span></span> <span data-ttu-id="14edb-106">大容量复制操作以非事务方式执行，不可以对其进行回滚。</span><span class="sxs-lookup"><span data-stu-id="14edb-106">The bulk copy operation occurs in a non-transacted way, with no opportunity for rolling it back.</span></span> <span data-ttu-id="14edb-107">如果需要在出错时回滚所有或部分大容量复制，则可以使用 <xref:System.Data.SqlClient.SqlBulkCopy> 托管的事务，在现有事务中执行大容量复制操作，或者在**系统事务**中登记 <xref:System.Transactions.Transaction> 。</span><span class="sxs-lookup"><span data-stu-id="14edb-107">If you need to roll back all or part of the bulk copy when an error occurs, you can use a <xref:System.Data.SqlClient.SqlBulkCopy>-managed transaction, perform the bulk copy operation within an existing transaction, or be enlisted in a **System.Transactions**<xref:System.Transactions.Transaction>.</span></span>  
  
## <a name="performing-a-non-transacted-bulk-copy-operation"></a><span data-ttu-id="14edb-108">执行非事务性批量复制操作</span><span class="sxs-lookup"><span data-stu-id="14edb-108">Performing a Non-transacted Bulk Copy Operation</span></span>  

 <span data-ttu-id="14edb-109">下面的控制台应用程序演示了非事务大容量复制操作在操作中途遇到错误时将发生什么情况。</span><span class="sxs-lookup"><span data-stu-id="14edb-109">The following Console application shows what happens when a non-transacted bulk copy operation encounters an error partway through the operation.</span></span>  
  
 <span data-ttu-id="14edb-110">在该示例中，源表和目标表分别包括一个名为 ProductID 的 `Identity` 列。</span><span class="sxs-lookup"><span data-stu-id="14edb-110">In the example, the source table and destination table each include an `Identity` column named **ProductID**.</span></span> <span data-ttu-id="14edb-111">该代码首先通过删除所有行，然后插入知道其 ProductID 存在于源表中的一行，准备目标表  。</span><span class="sxs-lookup"><span data-stu-id="14edb-111">The code first prepares the destination table by deleting all rows and then inserting a single row whose **ProductID** is known to exist in the source table.</span></span> <span data-ttu-id="14edb-112">默认情况下，系统会在目标表中为添加的每个行生成一个 `Identity` 列的新值。</span><span class="sxs-lookup"><span data-stu-id="14edb-112">By default, a new value for the `Identity` column is generated in the destination table for each row added.</span></span> <span data-ttu-id="14edb-113">在此示例中，在打开连接时设置某个选项，该选项用于强制执行大容量加载过程以改为使用源表中的 `Identity` 值。</span><span class="sxs-lookup"><span data-stu-id="14edb-113">In this example, an option is set when the connection is opened that forces the bulk load process to use the `Identity` values from the source table instead.</span></span>  
  
 <span data-ttu-id="14edb-114">执行大容量复制操作，并将 <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> 属性设置为 10。</span><span class="sxs-lookup"><span data-stu-id="14edb-114">The bulk copy operation is executed with the <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> property set to 10.</span></span> <span data-ttu-id="14edb-115">当操作遇到无效行时，将引发异常。</span><span class="sxs-lookup"><span data-stu-id="14edb-115">When the operation encounters the invalid row, an exception is thrown.</span></span> <span data-ttu-id="14edb-116">在此第一个示例中，大容量复制操作是非事务的。</span><span class="sxs-lookup"><span data-stu-id="14edb-116">In this first example, the bulk copy operation is non-transacted.</span></span> <span data-ttu-id="14edb-117">将提交在发生错误之前复制的所有批；将回滚包含重复项的批，并且在处理任何其他批之前中止大容量复制操作。</span><span class="sxs-lookup"><span data-stu-id="14edb-117">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="14edb-118">除非已按照 [大容量复制示例设置](bulk-copy-example-setup.md)中所述创建了工作表，否则此示例将不会运行。</span><span class="sxs-lookup"><span data-stu-id="14edb-118">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](bulk-copy-example-setup.md).</span></span> <span data-ttu-id="14edb-119">提供此代码是为了演示仅使用 SqlBulkCopy 时的语法。</span><span class="sxs-lookup"><span data-stu-id="14edb-119">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="14edb-120">如果源表和目标表位于同一 SQL Server 实例中，可以更便捷地使用 Transact-SQL `INSERT … SELECT` 语句复制数据。</span><span class="sxs-lookup"><span data-stu-id="14edb-120">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/VB/source.vb#1)]  
  
## <a name="performing-a-dedicated-bulk-copy-operation-in-a-transaction"></a><span data-ttu-id="14edb-121">在事务中执行专用的批量复制操作</span><span class="sxs-lookup"><span data-stu-id="14edb-121">Performing a Dedicated Bulk Copy Operation in a Transaction</span></span>  

 <span data-ttu-id="14edb-122">默认情况下，大容量复制操作是其自己的事务。</span><span class="sxs-lookup"><span data-stu-id="14edb-122">By default, a bulk copy operation is its own transaction.</span></span> <span data-ttu-id="14edb-123">在你要执行专用的大容量复制操作时，使用连接字符串创建 <xref:System.Data.SqlClient.SqlBulkCopy> 的新实例，或者在没有活动事务的情况下使用现有 <xref:System.Data.SqlClient.SqlConnection> 对象。</span><span class="sxs-lookup"><span data-stu-id="14edb-123">When you want to perform a dedicated bulk copy operation, create a new instance of <xref:System.Data.SqlClient.SqlBulkCopy> with a connection string, or use an existing <xref:System.Data.SqlClient.SqlConnection> object without an active transaction.</span></span> <span data-ttu-id="14edb-124">在每个方案中，将创建大容量复制操作，然后提交或回滚该事务。</span><span class="sxs-lookup"><span data-stu-id="14edb-124">In each scenario, the bulk copy operation creates, and then commits or rolls back the transaction.</span></span>  
  
 <span data-ttu-id="14edb-125">可以在 <xref:System.Data.SqlClient.SqlBulkCopy> 类构造函数中显式指定 <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> 选项，使大容量复制操作在其自己的事务中以显式方式执行，从而导致每批大容量复制操作在单独的事务中执行。</span><span class="sxs-lookup"><span data-stu-id="14edb-125">You can explicitly specify the <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> option in the <xref:System.Data.SqlClient.SqlBulkCopy> class constructor to explicitly cause a bulk copy operation to execute in its own transaction, causing each batch of the bulk copy operation to execute within a separate transaction.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="14edb-126">因为不同批在不同的事务中执行，因此如果在大容量复制操作期间出现错误，将回滚当前批中的所有行，但之前批中的行将保留在数据库中。</span><span class="sxs-lookup"><span data-stu-id="14edb-126">Since different batches are executed in different transactions, if an error occurs during the bulk copy operation, all the rows in the current batch will be rolled back, but rows from previous batches will remain in the database.</span></span>  
  
 <span data-ttu-id="14edb-127">下面的控制台应用程序与之前的示例类似，但有一个例外：在此示例中，大容量复制操作管理其自己的事务。</span><span class="sxs-lookup"><span data-stu-id="14edb-127">The following console application is similar to the previous example, with one exception: In this example, the bulk copy operation manages its own transactions.</span></span> <span data-ttu-id="14edb-128">将提交在发生错误之前复制的所有批；将回滚包含重复项的批，并且在处理任何其他批之前中止大容量复制操作。</span><span class="sxs-lookup"><span data-stu-id="14edb-128">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="14edb-129">除非已按照 [大容量复制示例设置](bulk-copy-example-setup.md)中所述创建了工作表，否则此示例将不会运行。</span><span class="sxs-lookup"><span data-stu-id="14edb-129">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](bulk-copy-example-setup.md).</span></span> <span data-ttu-id="14edb-130">提供此代码是为了演示仅使用 SqlBulkCopy 时的语法。</span><span class="sxs-lookup"><span data-stu-id="14edb-130">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="14edb-131">如果源表和目标表位于同一 SQL Server 实例中，可以更便捷地使用 Transact-SQL `INSERT … SELECT` 语句复制数据。</span><span class="sxs-lookup"><span data-stu-id="14edb-131">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/VB/source.vb#1)]  
  
## <a name="using-existing-transactions"></a><span data-ttu-id="14edb-132">使用现有事务</span><span class="sxs-lookup"><span data-stu-id="14edb-132">Using Existing Transactions</span></span>  

 <span data-ttu-id="14edb-133">可以指定现有 <xref:System.Data.SqlClient.SqlTransaction> 对象作为 <xref:System.Data.SqlClient.SqlBulkCopy> 构造函数中的参数。</span><span class="sxs-lookup"><span data-stu-id="14edb-133">You can specify an existing <xref:System.Data.SqlClient.SqlTransaction> object as a parameter in a <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span> <span data-ttu-id="14edb-134">在这种情况下，大容量复制操作在现有事务中执行，并且不对事务状态进行任何更改（即，既不提交也不中止该事务）。</span><span class="sxs-lookup"><span data-stu-id="14edb-134">In this situation, the bulk copy operation is performed in an existing transaction, and no change is made to the transaction state (that is, it is neither committed nor aborted).</span></span> <span data-ttu-id="14edb-135">这允许应用程序将大容量复制操作包含在带有其他数据库操作的事务中。</span><span class="sxs-lookup"><span data-stu-id="14edb-135">This allows an application to include the bulk copy operation in a transaction with other database operations.</span></span> <span data-ttu-id="14edb-136">不过，如果未指定 <xref:System.Data.SqlClient.SqlTransaction> 对象并传递空引用，且连接有活动事务，异常就会抛出。</span><span class="sxs-lookup"><span data-stu-id="14edb-136">However, if you do not specify a <xref:System.Data.SqlClient.SqlTransaction> object and pass a null reference, and the connection has an active transaction, an exception is thrown.</span></span>  
  
 <span data-ttu-id="14edb-137">如果由于出现错误而需要回滚整个大容量复制操作，或如果大容量复制应在可以回滚的较大进程中执行，你可以向 <xref:System.Data.SqlClient.SqlBulkCopy> 构造函数提供 <xref:System.Data.SqlClient.SqlTransaction> 对象。</span><span class="sxs-lookup"><span data-stu-id="14edb-137">If you need to roll back the entire bulk copy operation because an error occurs, or if the bulk copy should execute as part of a larger process that can be rolled back, you can provide a <xref:System.Data.SqlClient.SqlTransaction> object to the <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span>  
  
 <span data-ttu-id="14edb-138">下面的控制台应用程序与第一个（非事务）示例类似，但有一个例外：在此示例中，大容量复制操作包含在较大的外部事务中。</span><span class="sxs-lookup"><span data-stu-id="14edb-138">The following console application is similar to the first (non-transacted) example, with one exception: in this example, the bulk copy operation is included in a larger, external transaction.</span></span> <span data-ttu-id="14edb-139">发生主键冲突错误时，将回滚整个事务，并且不会向目标表添加任何行。</span><span class="sxs-lookup"><span data-stu-id="14edb-139">When the primary key violation error occurs, the entire transaction is rolled back and no rows are added to the destination table.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="14edb-140">除非已按照 [大容量复制示例设置](bulk-copy-example-setup.md)中所述创建了工作表，否则此示例将不会运行。</span><span class="sxs-lookup"><span data-stu-id="14edb-140">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](bulk-copy-example-setup.md).</span></span> <span data-ttu-id="14edb-141">提供此代码是为了演示仅使用 SqlBulkCopy 时的语法。</span><span class="sxs-lookup"><span data-stu-id="14edb-141">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="14edb-142">如果源表和目标表位于同一 SQL Server 实例中，可以更便捷地使用 Transact-SQL `INSERT … SELECT` 语句复制数据。</span><span class="sxs-lookup"><span data-stu-id="14edb-142">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/VB/source.vb#1)]  
  
## <a name="see-also"></a><span data-ttu-id="14edb-143">请参阅</span><span class="sxs-lookup"><span data-stu-id="14edb-143">See also</span></span>

- [<span data-ttu-id="14edb-144">SQL Server 中的批量复制操作</span><span class="sxs-lookup"><span data-stu-id="14edb-144">Bulk Copy Operations in SQL Server</span></span>](bulk-copy-operations-in-sql-server.md)
- [<span data-ttu-id="14edb-145">ADO.NET 概述</span><span class="sxs-lookup"><span data-stu-id="14edb-145">ADO.NET Overview</span></span>](../ado-net-overview.md)
