---
title: 发出用户代码跟踪
ms.date: 03/30/2017
ms.assetid: fa54186a-8ffa-4332-b0e7-63867126fd49
ms.openlocfilehash: e8b2031165a83e24ba15a2fcf847a170f47e696a
ms.sourcegitcommit: cdb295dd1db589ce5169ac9ff096f01fd0c2da9d
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 06/09/2020
ms.locfileid: "84589287"
---
# <a name="emitting-user-code-traces"></a><span data-ttu-id="9667e-102">发出用户代码跟踪</span><span class="sxs-lookup"><span data-stu-id="9667e-102">Emitting User-Code Traces</span></span>

<span data-ttu-id="9667e-103">除了在配置中启用跟踪以收集 Windows Communication Foundation （WCF）生成的检测数据之外，还可以通过编程方式在用户代码中发出跟踪。</span><span class="sxs-lookup"><span data-stu-id="9667e-103">In addition to enabling tracing in configuration to collect instrumentation data generated by Windows Communication Foundation (WCF), you can also emit traces programmatically in user code.</span></span> <span data-ttu-id="9667e-104">这样，您就可以主动创建检测数据，过后您可以细读这些数据以进行诊断。</span><span class="sxs-lookup"><span data-stu-id="9667e-104">In this way, you can proactively create instrumentation data that you can peruse later for diagnostic purpose.</span></span> <span data-ttu-id="9667e-105">本主题讨论如何实现这一目的。</span><span class="sxs-lookup"><span data-stu-id="9667e-105">This topic discusses how you can do this.</span></span>

<span data-ttu-id="9667e-106">此外，[扩展跟踪](../../samples/extending-tracing.md)示例包括以下部分中所示的所有代码。</span><span class="sxs-lookup"><span data-stu-id="9667e-106">In addition, the [Extending Tracing](../../samples/extending-tracing.md) sample includes all the code demonstrated in the following sections.</span></span>

## <a name="creating-a-trace-source"></a><span data-ttu-id="9667e-107">创建跟踪源</span><span class="sxs-lookup"><span data-stu-id="9667e-107">Creating a Trace Source</span></span>

<span data-ttu-id="9667e-108">你可以使用下列代码创建用户跟踪源。</span><span class="sxs-lookup"><span data-stu-id="9667e-108">You can use the following code to create a user trace source.</span></span>

```csharp
TraceSource ts = new TraceSource("myUserTraceSource");
```

## <a name="creating-activities"></a><span data-ttu-id="9667e-109">创建活动</span><span class="sxs-lookup"><span data-stu-id="9667e-109">Creating Activities</span></span>

<span data-ttu-id="9667e-110">活动是处理的逻辑单元。</span><span class="sxs-lookup"><span data-stu-id="9667e-110">Activities are logical unit of processing.</span></span> <span data-ttu-id="9667e-111">对于您希望在其中组合跟踪的每个主要处理单元，可为其创建一个活动。</span><span class="sxs-lookup"><span data-stu-id="9667e-111">You can create one activity for each major processing unit in which you want traces to be grouped together.</span></span> <span data-ttu-id="9667e-112">例如，您可以为服务的每个请求创建一个活动。</span><span class="sxs-lookup"><span data-stu-id="9667e-112">For example, you can create one activity for each request to the service.</span></span> <span data-ttu-id="9667e-113">为此，请执行下列步骤。</span><span class="sxs-lookup"><span data-stu-id="9667e-113">To do so, perform the following steps.</span></span>

1. <span data-ttu-id="9667e-114">在范围中保存活动 ID。</span><span class="sxs-lookup"><span data-stu-id="9667e-114">Save the activity ID in scope.</span></span>

2. <span data-ttu-id="9667e-115">创建一个新的活动 ID。</span><span class="sxs-lookup"><span data-stu-id="9667e-115">Create a new activity ID.</span></span>

3. <span data-ttu-id="9667e-116">将范围内的活动转移为新活动，将新活动设置在范围之内并对该活动发出初始跟踪。</span><span class="sxs-lookup"><span data-stu-id="9667e-116">Transfer from the activity in scope to the new one, set the new activity in scope and emit a start trace for that activity.</span></span>

<span data-ttu-id="9667e-117">下面的代码演示如何执行此操作。</span><span class="sxs-lookup"><span data-stu-id="9667e-117">The following code demonstrates how to do this.</span></span>

```csharp
Guid oldID = Trace.CorrelationManager.ActivityId;
Guid traceID = Guid.NewGuid();
ts.TraceTransfer(0, "transfer", traceID);
Trace.CorrelationManager.ActivityId = traceID; // Trace is static
ts.TraceEvent(TraceEventType.Start, 0, "Add request");
```

## <a name="emitting-traces-within-a-user-activity"></a><span data-ttu-id="9667e-118">在用户活动范围内发出跟踪</span><span class="sxs-lookup"><span data-stu-id="9667e-118">Emitting Traces within a User Activity</span></span>

<span data-ttu-id="9667e-119">下面的代码在用户活动范围内发出跟踪。</span><span class="sxs-lookup"><span data-stu-id="9667e-119">The following code emits traces within a user activity.</span></span>

```csharp
double value1 = 100.00D;
double value2 = 15.99D;
ts.TraceInformation("Client sends message to Add " + value1 + ", " + value2);
double result = client.Add(value1, value2);
ts.TraceInformation("Client receives Add response '" + result + "'");
```

## <a name="stopping-the-activities"></a><span data-ttu-id="9667e-120">停止活动</span><span class="sxs-lookup"><span data-stu-id="9667e-120">Stopping the Activities</span></span>

<span data-ttu-id="9667e-121">若要停止活动，请转回原来的活动，停止当前的活动 ID，然后再将旧的活动 ID 重置为范围内。</span><span class="sxs-lookup"><span data-stu-id="9667e-121">To stop the activities, transfer back to the old activity, stop the current activity id, and reset the old activity id in scope.</span></span>

<span data-ttu-id="9667e-122">下面的代码演示如何执行此操作。</span><span class="sxs-lookup"><span data-stu-id="9667e-122">The following code demonstrates how to do this.</span></span>

```csharp
ts.TraceTransfer(0, "transfer", oldID);
ts.TraceEvent(TraceEventType.Stop, 0, "Add request");
Trace.CorrelationManager.ActivityId = oldID;
```

## <a name="propagating-the-activity-id-to-a-service"></a><span data-ttu-id="9667e-123">向服务传播活动 ID</span><span class="sxs-lookup"><span data-stu-id="9667e-123">Propagating the Activity ID to A Service</span></span>

<span data-ttu-id="9667e-124">如果您将客户端和服务配置文件中的 `propagateActivity` 跟踪源的 `true` 属性设为 `System.ServiceModel`，将在客户端定义的相同活动中发生“加请求”的服务处理。</span><span class="sxs-lookup"><span data-stu-id="9667e-124">If you set the `propagateActivity` attribute to `true` for the `System.ServiceModel` trace source in both the client and service configuration files, the service processing for the Add request occurs in the same activity as the one defined in the client.</span></span> <span data-ttu-id="9667e-125">如果服务定义了自己的活动和转移，服务跟踪将不会出现在由客户端传播的活动中。</span><span class="sxs-lookup"><span data-stu-id="9667e-125">If the service defines its own activities and transfers, the service traces do not appear in the client-propagated activity.</span></span> <span data-ttu-id="9667e-126">相反，它们通过将跟踪转移到其 ID 由客户端传播的活动中出现在关联活动中。</span><span class="sxs-lookup"><span data-stu-id="9667e-126">Instead, they appear in an activity correlated by transfer traces to the activity whose ID is propagated by the client.</span></span>

> [!NOTE]
> <span data-ttu-id="9667e-127">如果 `propagateActivity` `true` 客户端和服务上的属性都设置为，则服务的操作范围内的环境活动由 WCF 设置。</span><span class="sxs-lookup"><span data-stu-id="9667e-127">If the `propagateActivity` attribute is set to `true` on both the client and service, the ambient activity in the operation scope of the service is set by WCF.</span></span>

<span data-ttu-id="9667e-128">你可以使用以下代码来检查 WCF 是否已在范围中设置活动。</span><span class="sxs-lookup"><span data-stu-id="9667e-128">You can use the following code to check whether an activity was set in scope by WCF.</span></span>

```csharp
// Check if an activity was set in scope by WCF, if it was
// propagated from the client. If not, ( ambient activity is
// equal to Guid.Empty), create a new one.
if(Trace.CorrelationManager.ActivityId == Guid.Empty)
{
    Guid newGuid = Guid.NewGuid();
    Trace.CorrelationManager.ActivityId = newGuid;
}
// Emit your Start trace.
ts.TraceEvent(TraceEventType.Start, 0, "Add Activity");

// Emit the processing traces for that request.
serviceTs.TraceInformation("Service receives Add "
                            + n1 + ", " + n2);
// double result = n1 + n2;
serviceTs.TraceInformation("Service sends Add result" + result);

// Emit the Stop trace and exit the method scope.
ts.TraceEvent(TraceEventType.Stop, 0, "Add Activity");
// return result;
```

## <a name="tracing-exceptions-thrown-in-code"></a><span data-ttu-id="9667e-129">跟踪代码中引发的异常</span><span class="sxs-lookup"><span data-stu-id="9667e-129">Tracing Exceptions Thrown in Code</span></span>

<span data-ttu-id="9667e-130">当你引发代码中的异常时，你还可以使用下面的代码跟踪“警告”级别或更高级别的异常。</span><span class="sxs-lookup"><span data-stu-id="9667e-130">When you throw an exception in code, you can also trace the exception at Warning level or up using the following code.</span></span>

```csharp
ts.TraceEvent(TraceEventType.Warning, 0, "Throwing exception " + "exceptionMessage");
```

## <a name="viewing-user-traces-in-the-service-trace-viewer-tool"></a><span data-ttu-id="9667e-131">在服务跟踪查看器工具中查看服务跟踪</span><span class="sxs-lookup"><span data-stu-id="9667e-131">Viewing User Traces in the Service Trace Viewer Tool</span></span>

<span data-ttu-id="9667e-132">本部分包含在使用[服务跟踪查看器工具（svctraceviewer.exe）](../../service-trace-viewer-tool-svctraceviewer-exe.md)进行查看时，通过运行[扩展跟踪](../../samples/extending-tracing.md)示例生成的跟踪的屏幕截图。</span><span class="sxs-lookup"><span data-stu-id="9667e-132">This section contains screenshots of traces generated by running the [Extending Tracing](../../samples/extending-tracing.md) sample, when viewed using the [Service Trace Viewer Tool (SvcTraceViewer.exe)](../../service-trace-viewer-tool-svctraceviewer-exe.md).</span></span>

<span data-ttu-id="9667e-133">在下图中，在左侧面板上选择了之前创建的 "添加请求" 活动。</span><span class="sxs-lookup"><span data-stu-id="9667e-133">In the following diagram, the "Add request" activity created previously is selected on the left panel.</span></span> <span data-ttu-id="9667e-134">它与其他三个构成应用程序客户端程序的数学运算活动（除、减、乘）列在一起。</span><span class="sxs-lookup"><span data-stu-id="9667e-134">It is listed with three other Math operation activities (Divide, Subtract, Multiply) that constitute the application client program.</span></span> <span data-ttu-id="9667e-135">用户代码对每个操作定义了一个新活动，以便隔离在不同请求中发生的潜在错误。</span><span class="sxs-lookup"><span data-stu-id="9667e-135">The user code has defined one new activity for each operation to isolate potential error occurrences in different requests.</span></span>

<span data-ttu-id="9667e-136">若要演示如何在[扩展跟踪](../../samples/extending-tracing.md)示例中使用传输，还会创建一个封装了四个操作请求的计算器活动。</span><span class="sxs-lookup"><span data-stu-id="9667e-136">To demonstrate the use of transfers in the [Extending Tracing](../../samples/extending-tracing.md) sample, a Calculator activity that encapsulates the four operation requests is also created.</span></span> <span data-ttu-id="9667e-137">对于每个请求，它们都将在“Calculator activity”（计算器活动）与请求活动之间来回转移（跟踪在图中的面板右上方突出显示）。</span><span class="sxs-lookup"><span data-stu-id="9667e-137">For each request, there is a transfer back and forth from the Calculator activity to the request activity (trace is highlighted in the upper right panel in the figure).</span></span>

<span data-ttu-id="9667e-138">当您在左面板选择了一个活动之后，此活动包括的跟踪将显示在面板右上方。</span><span class="sxs-lookup"><span data-stu-id="9667e-138">When you select an activity on the left panel, the traces included by this activity are shown on the upper right panel.</span></span> <span data-ttu-id="9667e-139">如果 `propagateActivity` 位于 `true` 请求路径中的每个终结点，则请求活动中的跟踪来自参与请求的所有进程。</span><span class="sxs-lookup"><span data-stu-id="9667e-139">If `propagateActivity` is `true` at every endpoint in the request path, traces in the request activity are from all processes that participate in the request.</span></span> <span data-ttu-id="9667e-140">在本示例中，您可以在面板的第 4 列看到来自客户端和服务的跟踪。</span><span class="sxs-lookup"><span data-stu-id="9667e-140">In this example, you can see traces from both the client and service in the 4th column in the panel.</span></span>

<span data-ttu-id="9667e-141">本活动显示下列处理顺序：</span><span class="sxs-lookup"><span data-stu-id="9667e-141">This activity shows the following order of processing:</span></span>

1. <span data-ttu-id="9667e-142">客户端向“Add”发送消息。</span><span class="sxs-lookup"><span data-stu-id="9667e-142">Client sends message to Add.</span></span>

2. <span data-ttu-id="9667e-143">服务接收“Add”请求消息。</span><span class="sxs-lookup"><span data-stu-id="9667e-143">Service receives Add request message.</span></span>

3. <span data-ttu-id="9667e-144">服务发送“Add”响应。</span><span class="sxs-lookup"><span data-stu-id="9667e-144">Service sends Add response.</span></span>

4. <span data-ttu-id="9667e-145">客户端接收“Add”响应。</span><span class="sxs-lookup"><span data-stu-id="9667e-145">Client receives Add response.</span></span>

<span data-ttu-id="9667e-146">所有这些跟踪均在“信息”级别发出。</span><span class="sxs-lookup"><span data-stu-id="9667e-146">All these traces were emitted at Information level.</span></span> <span data-ttu-id="9667e-147">单击面板右上方的跟踪将在面板右下方显示此跟踪的详细信息。</span><span class="sxs-lookup"><span data-stu-id="9667e-147">Clicking a trace in the upper-right panel shows the details of that trace in the lower-right panel.</span></span>

<span data-ttu-id="9667e-148">在下图中，我们还看到跟踪在“Calculator activity”（计算器活动）中来回转移，而且每个请求活动都具有两对“开始”和“停止”跟踪，一对用于客户端，另一对用于服务（每个跟踪源一对）。</span><span class="sxs-lookup"><span data-stu-id="9667e-148">In the following diagram, we also see transfer traces from and to the Calculator activity, as well as two pairs of Start and Stop traces per request activity, one for the client and one for the service (one for each trace source).</span></span>

<span data-ttu-id="9667e-149">![跟踪查看器：发出用户&#45;代码跟踪](media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd")按创建时间列出的活动列表（左面板）及其嵌套活动（右上面板）</span><span class="sxs-lookup"><span data-stu-id="9667e-149">![Trace Viewer: Emitting User&#45;code traces](media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd") List of activities by creation time (left panel) and their nested activities (upper-right panel)</span></span>

<span data-ttu-id="9667e-150">如果活动代码引发的异常会导致客户端引发异常（例如，当客户端没有获得请求的响应时），将在同一个直接相关的活动中显示服务和客户端警告或错误消息。</span><span class="sxs-lookup"><span data-stu-id="9667e-150">If the service code throws an exception that causes the client to throw as well (for example, when the client did not get the response to its request), both the service and client warning or error messages occur in the same activity for direct correlation.</span></span> <span data-ttu-id="9667e-151">在下图中，服务将引发异常，指出 "服务拒绝在用户代码中处理此请求"。</span><span class="sxs-lookup"><span data-stu-id="9667e-151">In the following image, the service throws an exception that states "The service refuses to process this request in user code."</span></span> <span data-ttu-id="9667e-152">客户端还会引发一个异常，指出 "由于内部错误，服务器无法处理该请求"。</span><span class="sxs-lookup"><span data-stu-id="9667e-152">The client also throws an exception that states "The server was unable to process the request due to an internal error."</span></span>

<span data-ttu-id="9667e-153">以下图像显示，如果已传播请求活动 id，则给定请求的终结点上的错误将出现在同一活动中：</span><span class="sxs-lookup"><span data-stu-id="9667e-153">The following images shows that errors across endpoints for a given request appear in the same activity if the request activity id was propagated:</span></span>

![显示给定请求跨终结点的错误的屏幕截图。](./media/emitting-user-code-traces/trace-viewer-endpoint-errors.gif)

<span data-ttu-id="9667e-155">在左面板上双击“乘”活动将显示下图，图中包含所涉及的每个进程的“乘”活动中的跟踪。</span><span class="sxs-lookup"><span data-stu-id="9667e-155">Double-clicking the Multiply activity on the left panel shows the following graph, with the traces for the Multiply activity for each process involved.</span></span> <span data-ttu-id="9667e-156">我们首先会看到服务上发生了一个警告（引发的异常），随后因无法处理请求而在客户端上显示警告和错误。</span><span class="sxs-lookup"><span data-stu-id="9667e-156">We can see a warning first occurred at the service (exception thrown), which is followed by warnings and errors on the client because the request could not be processed.</span></span> <span data-ttu-id="9667e-157">因此，我们可以由此获知终结点之间存在因果错误关系并推理出错误的根源。</span><span class="sxs-lookup"><span data-stu-id="9667e-157">Therefore, we can imply the causal error relationship between endpoints and derive the root cause of the error.</span></span>

<span data-ttu-id="9667e-158">下图显示了错误相关性的图形视图：</span><span class="sxs-lookup"><span data-stu-id="9667e-158">The following image shows a graph view of error correlation:</span></span>

![显示错误关联关系图视图的屏幕截图。](./media/emitting-user-code-traces/trace-viewer-error-correlation.gif)

<span data-ttu-id="9667e-160">若要获取之前的跟踪，我们为用户跟踪源设置 `ActivityTracing` 并为 `propagateActivity=true` 跟踪源设置 `System.ServiceModel`。</span><span class="sxs-lookup"><span data-stu-id="9667e-160">To obtain the previous traces, we set `ActivityTracing` for the user trace sources and `propagateActivity=true` for the `System.ServiceModel` trace source.</span></span> <span data-ttu-id="9667e-161">我们没有为 `ActivityTracing` 跟踪源设置 `System.ServiceModel`，以便实现用户代码活动之间的传播。</span><span class="sxs-lookup"><span data-stu-id="9667e-161">We did not set `ActivityTracing` for the `System.ServiceModel` trace source to enable user code to user code activity propagation.</span></span> <span data-ttu-id="9667e-162">（如果启用了 "用户活动跟踪"，则不会将客户端中定义的活动 ID 全部传播给服务用户代码;但传输会将客户端和服务用户代码活动与中间 WCF 活动相关联。）</span><span class="sxs-lookup"><span data-stu-id="9667e-162">(When ServiceModel activity tracing is on, the activity ID defined in the client is not propagated all the way to the service user code; Transfers, however, correlate the client and service user code activities to the intermediate WCF activities.)</span></span>

<span data-ttu-id="9667e-163">定义活动和传播活动 ID 使得我们可以对各终结点执行直接错误关联。</span><span class="sxs-lookup"><span data-stu-id="9667e-163">Defining activities and propagating the activity ID enables us to perform direct error correlation across endpoints.</span></span> <span data-ttu-id="9667e-164">这样，我们就可以更快地找到错误的根源。</span><span class="sxs-lookup"><span data-stu-id="9667e-164">In this way, we can locate the root cause of an error more quickly.</span></span>

## <a name="see-also"></a><span data-ttu-id="9667e-165">另请参阅</span><span class="sxs-lookup"><span data-stu-id="9667e-165">See also</span></span>

- [<span data-ttu-id="9667e-166">扩展跟踪</span><span class="sxs-lookup"><span data-stu-id="9667e-166">Extending Tracing</span></span>](../../samples/extending-tracing.md)
